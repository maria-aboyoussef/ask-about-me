<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- ... (بقية ال head كما هي) ... -->
    <style>
        /* إضافة أنماط جديدة */
        .welcome-message {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .import-container {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px dashed var(--primary);
        }
    </style>
</head>
<body>
    <!-- ... (بقية الجسم كما هي) ... -->
    
    <!-- إضافة منطقة الترحيب في الصفحة الرئيسية -->
    <div id="homePage" class="page active-page">
        <div class="alert alert-success">
            <!-- ... -->
        </div>
        
        <!-- إضافة رسالة ترحيب -->
        <div class="welcome-message" id="welcomeMessage">
            <i class="fas fa-user-circle"></i>
            <div>
                <strong id="loggedInUser">مرحباً!</strong>
                <p id="userRole">يتم تحميل معلومات المستخدم...</p>
            </div>
        </div>
        
        <!-- ... (بقية الصفحة الرئيسية) ... -->
    </div>
    
    <!-- ... (بقية الصفحات) ... -->
    
    <!-- نافذة تأكيد حذف الخادم -->
    <div id="deleteServantConfirmation" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-exclamation-triangle"></i> تأكيد حذف الخادم</h2>
            <p>هل أنت متأكد أنك تريد حذف هذا الخادم؟</p>
            <p><strong id="servantToDelete">[اسم الخادم]</strong></p>
            <p>هذا الإجراء لا يمكن التراجع عنه وسيتم حذف جميع بيانات الخادم نهائياً.</p>
            
            <div class="confirmation-buttons">
                <button id="confirmServantDeleteBtn" class="delete-btn">
                    <i class="fas fa-trash"></i> نعم، احذف الخادم
                </button>
                <button id="cancelServantDeleteBtn">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة إضافة/تعديل الخادم -->
    <div id="servantFormModal" class="modal">
        <div class="modal-content">
            <h2 id="servantFormTitle"><i class="fas fa-user-plus"></i> إضافة خادم جديد</h2>
            
            <div class="input-group">
                <label for="servantName">اسم الخادم</label>
                <input type="text" id="servantName" placeholder="اسم الخادم">
            </div>
            
            <div class="input-group">
                <label for="servantPhoneForm">رقم الهاتف</label>
                <input type="tel" id="servantPhoneForm" placeholder="رقم هاتف الخادم">
            </div>
            
            <div class="input-group">
                <label for="servantPassword">كلمة المرور</label>
                <input type="password" id="servantPassword" placeholder="كلمة مرور الخادم">
            </div>
            
            <div class="input-group">
                <label for="servantConfirmPassword">تأكيد كلمة المرور</label>
                <input type="password" id="servantConfirmPassword" placeholder="تأكيد كلمة المرور">
            </div>
            
            <div class="error-message" id="servantFormError"></div>
            
            <div class="confirmation-buttons">
                <button id="saveServantBtn">
                    <i class="fas fa-save"></i> حفظ
                </button>
                <button id="cancelServantBtn">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- زر إضافة عضو جديد -->
    <button class="add-btn" id="addMemberBtn" title="إضافة عضو جديد">
        <i class="fas fa-plus"></i>
    </button>

    <script>
        // ... (بقية المتغيرات كما هي) ...
        
        // عناصر جديدة
        const welcomeMessage = document.getElementById('welcomeMessage');
        const loggedInUser = document.getElementById('loggedInUser');
        const userRole = document.getElementById('userRole');
        const deleteServantConfirmation = document.getElementById('deleteServantConfirmation');
        const servantToDelete = document.getElementById('servantToDelete');
        const confirmServantDeleteBtn = document.getElementById('confirmServantDeleteBtn');
        const cancelServantDeleteBtn = document.getElementById('cancelServantDeleteBtn');
        const servantFormModal = document.getElementById('servantFormModal');
        const servantFormTitle = document.getElementById('servantFormTitle');
        const saveServantBtn = document.getElementById('saveServantBtn');
        const cancelServantBtn = document.getElementById('cancelServantBtn');
        const servantFormError = document.getElementById('servantFormError');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const excelFileInput = document.createElement('input');
        excelFileInput.type = 'file';
        excelFileInput.accept = '.xlsx, .xls';
        excelFileInput.style.display = 'none';
        document.body.appendChild(excelFileInput);
        
        // عند الدخول
        loginBtn.addEventListener('click', function() {
            // ... (بقية كود الدخول) ...
            
            if(userType === 'admin') {
                if(enteredCode === INVITE_CODE) {
                    currentUser = { 
                        type: 'admin',
                        name: 'المسؤول'
                    };
                    // ... (بقية كود الدخول) ...
                    
                    // تحديث رسالة الترحيب
                    updateUserWelcome();
                }
            } else if(userType === 'servant') {
                // ... (بقية كود الدخول) ...
                
                if(servant) {
                    currentUser = {
                        type: 'servant',
                        id: servant.id,
                        name: servant.name
                    };
                    // ... (بقية كود الدخول) ...
                    
                    // تحديث رسالة الترحيب
                    updateUserWelcome();
                }
            }
            // ... (بقية كود الدخول) ...
        });
        
        // تحديث رسالة الترحيب
        function updateUserWelcome() {
            if(currentUser) {
                loggedInUser.textContent = `مرحباً ${currentUser.name}!`;
                userRole.textContent = `(${currentUser.type === 'admin' ? 'المسؤول' : 'خادم'})`;
            }
        }
        
        // وظائف صفحة الخدام
        function setupServantsPage() {
            // إضافة مستمعات الأحداث لأزرار الخدام
            document.querySelectorAll('.edit-servant').forEach(btn => {
                btn.addEventListener('click', function() {
                    const servantId = this.getAttribute('data-id');
                    openServantForm(servantId);
                });
            });
            
            document.querySelectorAll('.delete-servant').forEach(btn => {
                btn.addEventListener('click', function() {
                    const servantId = this.getAttribute('data-id');
                    const servant = servants.find(s => s.id == servantId);
                    if(servant) {
                        servantToDelete.textContent = servant.name;
                        deleteServantConfirmation.style.display = 'flex';
                        deleteServantConfirmation.setAttribute('data-id', servantId);
                    }
                });
            });
            
            document.querySelectorAll('.reports-servant').forEach(btn => {
                btn.addEventListener('click', function() {
                    const servantId = this.getAttribute('data-id');
                    alert(`سيتم عرض تقارير الخادم (ID: ${servantId}) - هذه الميزة قيد التطوير`);
                });
            });
        }
        
        // فتح نموذج الخادم
        function openServantForm(servantId = null) {
            servantFormError.textContent = '';
            servantFormError.style.display = 'none';
            
            if(servantId) {
                // وضع التعديل
                const servant = servants.find(s => s.id == servantId);
                if(servant) {
                    servantFormTitle.innerHTML = '<i class="fas fa-user-edit"></i> تعديل بيانات الخادم';
                    document.getElementById('servantName').value = servant.name;
                    document.getElementById('servantPhoneForm').value = servant.phone;
                    document.getElementById('servantPassword').value = '';
                    document.getElementById('servantConfirmPassword').value = '';
                    servantFormModal.setAttribute('data-id', servantId);
                }
            } else {
                // وضع الإضافة
                servantFormTitle.innerHTML = '<i class="fas fa-user-plus"></i> إضافة خادم جديد';
                document.getElementById('servantName').value = '';
                document.getElementById('servantPhoneForm').value = '';
                document.getElementById('servantPassword').value = '';
                document.getElementById('servantConfirmPassword').value = '';
                servantFormModal.removeAttribute('data-id');
            }
            
            servantFormModal.style.display = 'flex';
        }
        
        // حفظ بيانات الخادم
        saveServantBtn.addEventListener('click', function() {
            const name = document.getElementById('servantName').value.trim();
            const phone = document.getElementById('servantPhoneForm').value.trim();
            const password = document.getElementById('servantPassword').value;
            const confirmPassword = document.getElementById('servantConfirmPassword').value;
            const servantId = servantFormModal.getAttribute('data-id');
            
            // التحقق من البيانات
            if(!name || !phone || !password) {
                showServantError('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            if(password !== confirmPassword) {
                showServantError('كلمة المرور وتأكيدها غير متطابقين');
                return;
            }
            
            if(servantId) {
                // تحديث الخادم الموجود
                const index = servants.findIndex(s => s.id == servantId);
                if(index !== -1) {
                    servants[index].name = name;
                    servants[index].phone = phone;
                    servants[index].password = password;
                }
            } else {
                // إضافة خادم جديد
                const newServant = {
                    id: Date.now(),
                    name: name,
                    phone: phone,
                    password: password
                };
                servants.push(newServant);
            }
            
            // إعادة عرض الخدام
            renderServants();
            servantFormModal.style.display = 'none';
            alert(`تم ${servantId ? 'تحديث' : 'إضافة'} الخادم بنجاح`);
        });
        
        // إظهار خطأ في نموذج الخادم
        function showServantError(message) {
            servantFormError.textContent = message;
            servantFormError.style.display = 'block';
        }
        
        // حذف الخادم
        confirmServantDeleteBtn.addEventListener('click', function() {
            const servantId = deleteServantConfirmation.getAttribute('data-id');
            if(servantId) {
                servants = servants.filter(s => s.id != servantId);
                renderServants();
                deleteServantConfirmation.style.display = 'none';
                alert('تم حذف الخادم بنجاح');
            }
        });
        
        // إلغاء حذف الخادم
        cancelServantDeleteBtn.addEventListener('click', function() {
            deleteServantConfirmation.style.display = 'none';
        });
        
        // إلغاء نموذج الخادم
        cancelServantBtn.addEventListener('click', function() {
            servantFormModal.style.display = 'none';
        });
        
        // عرض الخدام
        function renderServants() {
            const servantsList = document.getElementById('servantsList');
            servantsList.innerHTML = '';
            
            servants.forEach(servant => {
                const servantCard = document.createElement('div');
                servantCard.className = 'servant-card';
                servantCard.innerHTML = `
                    <h3><i class="fas fa-user"></i> ${servant.name}</h3>
                    <div class="member-info">
                        <i class="fas fa-phone"></i>
                        <span><strong>رقم الهاتف:</strong> ${servant.phone}</span>
                    </div>
                    <div class="servant-actions">
                        <button class="action-btn edit-servant" data-id="${servant.id}">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="action-btn delete delete-servant" data-id="${servant.id}">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                        <button class="action-btn reports-servant" data-id="${servant.id}">
                            <i class="fas fa-chart-bar"></i> التقارير
                        </button>
                    </div>
                `;
                servantsList.appendChild(servantCard);
            });
            
            // إعداد الأزرار بعد العرض
            setupServantsPage();
        }
        
        // استيراد الأعضاء من Excel
        importExcelBtn.addEventListener('click', function() {
            excelFileInput.click();
        });
        
        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // الحصول على أول ورقة عمل
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // تحويل إلى JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // معالجة البيانات
                    const importedMembers = jsonData.map(row => ({
                        id: Date.now() + Math.floor(Math.random() * 1000), // ID فريد
                        fullName: row['الاسم الكامل'] || '',
                        memberType: row['النوع'] || 'بابا',
                        phone: row['الهاتف'] || '',
                        address: row['العنوان'] || '',
                        childrenCount: row['عدد الأطفال'] || 0,
                        childrenAges: row['أعمار الأطفال'] || '',
                        notes: row['ملاحظات'] || '',
                        barcode: Math.random().toString(36).substr(2, 9).toUpperCase()
                    }));
                    
                    // إضافة للأعضاء
                    members = members.concat(importedMembers);
                    loadMembers();
                    updateStatistics();
                    
                    alert(`تم استيراد ${importedMembers.length} عضو بنجاح`);
                } catch (error) {
                    console.error('Error importing Excel:', error);
                    alert('حدث خطأ أثناء استيراد الملف. يرجى التأكد من صيغة الملف.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        });
        
        // عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', function() {
            // ... (بقية كود التحميل) ...
            
            // إعداد صفحة الخدام عند عرضها
            servantsBtn.addEventListener('click', function() {
                renderServants();
                showPage(servantsPage);
            });
        });
    </script>
</body>
</html>
